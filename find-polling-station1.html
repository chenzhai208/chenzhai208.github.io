<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NJ Polling Stations - Google Maps</title>
  <style>
    #map {
      height: 90vh;
      width: 100%;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }
    #status {
      padding: 10px;
      font-weight: bold;
      background: #f0f0f0;
      color: #333;
    }
  </style>
</head>
<body>
  <div id="status">Loading map and polling stations...</div>
  <div id="map"></div>

  <script>
    let map;
    let userMarker = null;
    let pollingMarkers = [];
    let infoWindow;

    const countyIcons = {
      'Morris': 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png',
      'Burlington': 'https://maps.google.com/mapfiles/ms/icons/green-dot.png',
      'Essex': 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
      'Hudson': 'https://maps.google.com/mapfiles/ms/icons/yellow-dot.png',
    };

    const counties = [
      {
        name: 'Morris',
        url: 'https://morrisgisapps.co.morris.nj.us/arcgis/rest/services/ELECTIONS/ElectionsFS/FeatureServer/0/query?where=1=1&outFields=*&f=geojson'
      },
      {
        name: 'Burlington',
        url: 'https://gisportal.co.burlington.nj.us/hosting/rest/services/Elections/MapServer/1/query?where=1=1&outFields=*&f=geojson'
      },
      {
        name: 'Essex',
        url: 'https://services3.arcgis.com/fjS7FqW6a70Om4Qu/arcgis/rest/services/Essex_Polling_Places/FeatureServer/0/query?where=1=1&outFields=*&f=geojson'
      },
      {
        name: 'Hudson',
        url: 'https://services5.arcgis.com/XDJlB0gZLOv8P5cv/arcgis/rest/services/Hudson_Polling_Places/FeatureServer/0/query?where=1=1&outFields=*&f=geojson'
      }
    ];

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 40.0, lng: -74.5 },
        zoom: 9,
      });
      infoWindow = new google.maps.InfoWindow();

      // 先加载投票站
      loadAllPollingStations()
        .then(() => {
          // 再定位用户
          locateUserAndFindNearest();
        })
        .catch(err => {
          document.getElementById('status').innerText = 'Error loading polling stations.';
          console.error(err);
        });
    }

    async function loadAllPollingStations() {
      document.getElementById('status').innerText = 'Loading polling stations data...';

      const promises = counties.map(async county => {
        const res = await fetch(county.url);
        if (!res.ok) throw new Error(`Failed to load data for ${county.name}`);
        const geojson = await res.json();

        geojson.features.forEach(feature => {
          const coords = feature.geometry.coordinates;
          const latLng = new google.maps.LatLng(coords[1], coords[0]);

          const name = feature.properties.name || feature.properties.LOCATION || feature.properties.Location || 'Polling Station';

          const marker = new google.maps.Marker({
            position: latLng,
            map: map,
            title: `${name} (${county.name})`,
            icon: countyIcons[county.name] || countyIcons['Morris'],
          });

          marker.addListener('click', () => {
            infoWindow.setContent(`<strong>${name}</strong><br><em>${county.name} County</em>`);
            infoWindow.open(map, marker);
          });

          pollingMarkers.push(marker);
        });
      });

      await Promise.all(promises);

      document.getElementById('status').innerText = 'Polling stations loaded.';
    }

    function locateUserAndFindNearest() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          position => {
            const userPos = {
              lat: position.coords.latitude,
              lng: position.coords.longitude,
            };

            // 用户位置marker
            if (userMarker) userMarker.setMap(null);
            userMarker = new google.maps.Marker({
              position: userPos,
              map: map,
              title: 'Your Location',
              icon: 'https://maps.google.com/mapfiles/ms/icons/blue-pushpin.png',
            });

            map.setCenter(userPos);
            map.setZoom(14);

            // 找最近投票站
            let nearestMarker = null;
            let minDist = Infinity;

            pollingMarkers.forEach(marker => {
              const dist = google.maps.geometry.spherical.computeDistanceBetween(
                new google.maps.LatLng(userPos.lat, userPos.lng),
                marker.getPosition()
              );
              if (dist < minDist) {
                minDist = dist;
                nearestMarker = marker;
              }
            });

            if (nearestMarker) {
              infoWindow.setContent(`${nearestMarker.getTitle()}<br><b>Distance:</b> ${minDist.toFixed(0)} meters`);
              infoWindow.open(map, nearestMarker);
              map.panTo(nearestMarker.getPosition());
              map.setZoom(16);
              document.getElementById('status').innerText = `Nearest polling station: ${nearestMarker.getTitle()} (${minDist.toFixed(0)} meters away)`;
            } else {
              document.getElementById('status').innerText = 'No polling stations found.';
            }
          },
          () => {
            document.getElementById('status').innerText = 'Error: The Geolocation service failed.';
          }
        );
      } else {
        document.getElementById('status').innerText = 'Error: Your browser doesn\'t support geolocation.';
      }
    }
  </script>

  <!-- 请替换 YOUR_API_KEY -->
  <script
    async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB0ObvzXqtJf4RhSKgu_4Eh5I7LrUFIePs&callback=initMap&libraries=geometry"
    async
    defer
  ></script>
</body>
</html>
