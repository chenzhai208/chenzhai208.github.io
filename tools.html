<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Tools</title>
  <link rel="stylesheet" href="styles.css"/>

  <style>
    /* Header layout (site nav) */
    .contact-local header .wrap{
      display:flex; align-items:center; justify-content:space-between;
    }
    .contact-local header nav ul{
      margin-left:auto; display:flex; gap:1rem; justify-content:flex-end;
      list-style:none; padding:0;
    }

    /* è®©é¡¶éƒ¨å¯¼èˆªèƒŒæ™¯é€æ˜ã€æ–‡æœ¬é¢œè‰²ç»§æ‰¿ */
    .contact-local > header{
      background: transparent;
      color: inherit;
      padding: 10px 0; /* ä¿ç•™å†…è¾¹è·ä»¥ç»´æŒå¸ƒå±€ */
    }

    /* Wider unified form layout */
    .contact-local form{
      max-width:560px;
      margin:0 auto;
      padding:0 1rem;
      text-align:left;
    }
    .contact-local label{
      display:block;
      margin:.5rem 0 .25rem;
      text-align:left;
    }
    .contact-local input[type="text"],
    .contact-local input[type="email"],
    .contact-local textarea{
      display:block;
      width:100%;
      max-width:100%;
      margin:0;
      box-sizing:border-box;
      padding:.75rem 1rem;
      border:1px solid #ccc;
      border-radius:.5rem;
      font:inherit;
    }
    .contact-local button[type="submit"]{
      margin-top:.9rem;
      padding:.7rem 1.1rem;
      border:0; border-radius:.6rem; cursor:pointer; font:inherit;
    }
    @media (max-width:520px){
      .contact-local form{ max-width:100%; }
    }

    /* ====== å¡ç‰‡é€šç”¨å¤–è§‚ ====== */
    #election-events > h2{
      text-align: center;
      margin-bottom: .75rem;
    }
    #events-list{
      max-width: 720px;
      margin: 0 auto;
    }
    .event{
      background: var(--card-bg, #fff);
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,.06);
      margin: 12px 0;
    }
    .event > h3{ margin-top: 0; }
    .event .candidates h4{
      margin-bottom: .5rem;
    }
    .event .candidates ul{
      padding-left: 1.25rem;
      margin: 0;
    }

    /* ------- é¡µé¢é€šç”¨ ------- */
    body { margin: 0; font-family: Arial, sans-serif; }

    /* åªç»™é¡µè„šä½¿ç”¨è“åº•ï¼ˆå¯¼èˆªä¿æŒé€æ˜ï¼‰ */
    footer {
      background-color: #004080;
      color: white;
      padding: 10px;
      text-align: center;
    }

    main { padding: 20px; }
    #map { height: 500px; width: 100%; margin-top: 20px; }

    button {
      padding: 10px 20px;
      background-color: #004080;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 8px;
    }

    /* ====== æ–¹æ¡ˆ2ï¼šåŒè¡ŒæŒ‰é’® + å³ä¾§æ¨é€ ====== */
    .actions-row{ display:flex; align-items:center; gap:10px; margin:14px 0 0; }
    .push-right{ margin-left:auto; }

    /* ====== æé†’å¼¹çª—æ ·å¼ ====== */
    .modal-backdrop{
      position: fixed; inset: 0; background: rgba(0,0,0,.35);
      display: none; align-items: center; justify-content: center; z-index: 999;
    }
    .modal{
      width: min(680px, 92vw);
      background: #fff; border-radius: 12px; padding: 16px 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,.2);
    }
    .modal header{ font-weight: 700; margin-bottom: 8px; }
    .modal .row{ display:flex; gap:10px; }
    .modal label{ font-size:.9rem; margin:.4rem 0 .25rem; display:block; }
    .modal input, .modal textarea{
      width:100%; padding:.6rem .75rem; border:1px solid #d1d5db; border-radius:8px; font:inherit;
    }
    .modal .actions{ display:flex; justify-content:flex-end; gap:10px; margin-top:12px; }
    .btn{ padding:.6rem .9rem; border:0; border-radius:8px; cursor:pointer; font:inherit; background:#111827; color:#fff; }
    .btn.primary{ background:#004080; }
    .btn.ghost{ background:#e5e7eb; color:#111827; }

    @media (max-width:600px){ .modal .row{ flex-direction: column; } }
  </style>
</head>

<body class="contact-local">
  <!-- é¡¶éƒ¨ç«™ç‚¹å¯¼èˆªï¼ˆé€æ˜ï¼‰ -->
  <header>
    <div class="wrap">
      <h1 class="logo">YouthVotesMatter.Org</h1>
      <nav>
        <ul>
          <li><a href="index.html">Home</a></li>
          <li><a href="about.html">About</a></li>
          <li><a href="contact.html">Contact</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main>
    <p>Click the button below to find your location on the map:</p>

    <!-- æ–¹æ¡ˆ2ï¼šLocate Me å·¦ä¾§ï¼ŒSet Reminder å³ä¾§ -->
    <div class="actions-row">
      <button onclick="locateUser()">Locate Me</button>
      <button class="push-right" onclick="openReminderModal()">Set Reminder</button>
    </div>

    <div id="map"></div>
  </main>

  <footer>
    &copy; 2024-2025 YouthVotesMatter.ORG
  </footer>

  <!-- ============ ä¸šåŠ¡è„šæœ¬ï¼ˆå…ˆå®šä¹‰ï¼Œå†åŠ è½½ Google Mapsï¼‰ ============ -->
  <script>
    let map, userMarker, infoWindow;
    let selectedAddress = ""; // é€‰ä¸­çš„åœ°å€ï¼ˆç‚¹å‡»åœ°å›¾æˆ–å®šä½åå†™å…¥ï¼‰

    // ç¡®ä¿ Google Maps å›è°ƒå¯ç”¨
    window.initMap = function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 40.0, lng: -74.5 }, // Default center
        zoom: 8,
      });
      infoWindow = new google.maps.InfoWindow();
      addReverseGeocodeListener();
    };

    function locateUser() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          async (position) => {
            const pos = { lat: position.coords.latitude, lng: position.coords.longitude };

            if (userMarker) userMarker.setMap(null);
            userMarker = new google.maps.Marker({
              position: pos,
              map: map,
              title: "You are here",
              label: "ğŸ“",
            });

            map.setCenter(pos);
            map.setZoom(14);

            // åå‘åœ°ç†ç¼–ç ï¼Œå†™å…¥ selectedAddressï¼Œæ–¹ä¾¿æé†’é»˜è®¤åœ°ç‚¹
            try {
              selectedAddress = await reverseGeocode(pos.lat, pos.lng);
            } catch(e){ console.warn(e); }
          },
          () => { alert("Geolocation service failed."); }
        );
      } else {
        alert("Your browser doesn't support geolocation.");
      }
    }

    function addReverseGeocodeListener() {
      map.addListener("click", async (e) => {
        const lat = e.latLng.lat();
        const lng = e.latLng.lng();
        try {
          const address = await reverseGeocode(lat, lng);
          selectedAddress = address;
          infoWindow.setContent(address);
          infoWindow.setPosition(e.latLng);
          infoWindow.open(map);
        } catch (error) {
          console.error("Geocoding error:", error);
          alert("Failed to fetch address.");
        }
      });
    }

    async function reverseGeocode(lat, lng){
      const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
      const data = await response.json();
      return data.display_name || "Address not found";
    }

    /* ================== Set Reminder é€»è¾‘ ================== */
    function openReminderModal(){
      // é»˜è®¤æ ‡é¢˜ã€åœ°ç‚¹ä¸é»˜è®¤æ—¶é—´ï¼ˆ3 å¤©å 09:00ï¼‰
      document.getElementById("remTitle").value = "Go Vote";
      document.getElementById("remLocation").value = selectedAddress || "";
      const now = new Date();
      const d = new Date(now.getTime() + 3*24*60*60*1000);
      document.getElementById("remDate").value = toYMD(d);
      document.getElementById("remTime").value = "09:00";
      document.getElementById("reminderModal").style.display = "flex";
    }
    function closeReminderModal(){
      document.getElementById("reminderModal").style.display = "none";
    }

    function toYMD(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }
    function toICSDateUTC(d){
      const yyyy = d.getUTCFullYear();
      const mm = String(d.getUTCMonth()+1).padStart(2,"0");
      const dd = String(d.getUTCDate()).padStart(2,"0");
      const hh = String(d.getUTCHours()).padStart(2,"0");
      const mi = String(d.getUTCMinutes()).padStart(2,"0");
      const ss = String(d.getUTCSeconds()).padStart(2,"0");
      return `${yyyy}${mm}${dd}T${hh}${mi}${ss}Z`;
    }
    function escapeICS(text){
      return String(text || "")
        .replace(/\\/g,"\\\\")
        .replace(/;/g,"\\;")
        .replace(/,/g,"\\,")
        .replace(/\n/g,"\\n");
    }

    async function tryScheduleBrowserNotification(when, title, location){
      if (!("Notification" in window)) return;
      try{
        let perm = Notification.permission;
        if (perm !== "granted"){
          perm = await Notification.requestPermission();
        }
        if (perm !== "granted") return;

        const delay = when.getTime() - Date.now();
        // æœ€å¤šåªå…è®¸ 30 å¤©å†…çš„æœ¬åœ°æé†’
        if (delay > 0 && delay <= 30*24*60*60*1000){
          setTimeout(() => {
            new Notification(title || "Reminder", {
              body: location ? `Location: ${location}` : "Voting reminder",
            });
          }, delay);
        }
      }catch(e){
        console.warn("Notifications not scheduled:", e);
      }
    }

    function makeICS(){
      const title = (document.getElementById("remTitle").value || "Go Vote").trim();
      const date = document.getElementById("remDate").value;
      const time = document.getElementById("remTime").value || "09:00";
      const loc  = document.getElementById("remLocation").value || "";
      const notes= document.getElementById("remNotes").value || "";

      if(!date){
        alert("Please select a date.");
        return;
      }
      // æœ¬åœ°æ—¶åŒºèµ·æ­¢æ—¶é—´ï¼ˆé»˜è®¤ 1 å°æ—¶ï¼‰
      const [hh, mm] = time.split(":");
      const startLocal = new Date(date + "T" + (hh?hh:"09") + ":" + (mm?mm:"00") + ":00");
      const endLocal = new Date(startLocal.getTime() + 60*60*1000);

      const dtStart = toICSDateUTC(startLocal);
      const dtEnd   = toICSDateUTC(endLocal);
      const dtStamp = toICSDateUTC(new Date());
      const uid = `yvm-${Date.now()}@youthvotesmatter`;

      const ics =
`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//YouthVotesMatter//EN
CALSCALE:GREGORIAN
METHOD:PUBLISH
BEGIN:VEVENT
UID:${uid}
DTSTAMP:${dtStamp}
DTSTART:${dtStart}
DTEND:${dtEnd}
SUMMARY:${escapeICS(title)}
DESCRIPTION:${escapeICS(notes)}
LOCATION:${escapeICS(loc)}
END:VEVENT
END:VCALENDAR`;

      // ä¸‹è½½ .ics
      const blob = new Blob([ics], {type:"text/calendar;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = `${title.replace(/\s+/g,"_")}.ics`;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);

      // æ‰“å¼€ Google Calendar å¿«æ·æ·»åŠ 
      const gTitle = encodeURIComponent(title);
      const gDetails = encodeURIComponent(notes || "");
      const gLocation = encodeURIComponent(loc || "");
      const gDates = `${dtStart}/${dtEnd}`;
      const gcal = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${gTitle}&dates=${gDates}&details=${gDetails}&location=${gLocation}`;
      window.open(gcal, "_blank");

      // æœ¬åœ°é€šçŸ¥ï¼ˆå¦‚å…è®¸ï¼‰
      tryScheduleBrowserNotification(startLocal, title, loc);

      // å…³é—­å¼¹çª—
      closeReminderModal();
    }

    // ç‚¹å‡»é®ç½©å…³é—­å¼¹çª—
    window.addEventListener("click", (e)=>{
      document.querySelectorAll(".modal-backdrop").forEach(m=>{
        if (e.target === m) m.style.display = "none";
      });
    });
  </script>

  <!-- Google Maps APIï¼ˆè¯·æ›¿æ¢ä¸ºä½ çš„æœ‰æ•ˆ KEYï¼Œå¦‚éœ€ï¼‰ -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB0ObvzXqtJf4RhSKgu_4Eh5I7LrUFIePs&callback=initMap" async defer></script>

  <!-- ====== Set Reminder æ¨¡æ€æ¡† ====== -->
  <div id="reminderModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="reminderTitle">
    <div class="modal">
      <header id="reminderTitle">Set Voting Reminder</header>
      <div class="row">
        <div style="flex:1">
          <label for="remTitle">Title</label>
          <input id="remTitle" type="text" placeholder="Go Vote"/>
        </div>
      </div>
      <div class="row">
        <div style="flex:1">
          <label for="remDate">Date</label>
          <input id="remDate" type="date"/>
        </div>
        <div style="flex:1">
          <label for="remTime">Time</label>
          <input id="remTime" type="time" />
        </div>
      </div>
      <label for="remLocation">Location (optional)</label>
      <input id="remLocation" type="text" placeholder="Polling place or address"/>
      <label for="remNotes">Notes (optional)</label>
      <textarea id="remNotes" rows="3" placeholder="Bring ID, review ballot..."></textarea>

      <div class="actions">
        <button class="btn ghost" onclick="closeReminderModal()">Cancel</button>
        <button class="btn primary" onclick="makeICS()">Save & Add to Google Calendar</button>
      </div>
      <p class="hint">We'll download an .ics file and open Google Calendar prefilled. If notifications are allowed, a local browser reminder will be scheduled.</p>
    </div>
  </div>
</body>
</html>
